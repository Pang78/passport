import openai
import pandas as pd
import base64

# Set your OpenAI API key
openai.api_key = "your_openai_api_key_here"

def encode_image_to_base64(image_path):
    """Encode an image to base64."""
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")

def extract_passport_details(image_path):
    """Extract passport details using OpenAI Vision API."""
    # Encode the image to base64
    base64_image = encode_image_to_base64(image_path)

    # Define the prompt for the Vision API
    prompt = """
    Extract the following details from the passport image:
    - Full Name
    - Passport Number
    - Nationality
    - Date of Birth
    - Expiration Date

    Return the details in JSON format.
    """

    # Call the OpenAI Vision API
    response = openai.ChatCompletion.create(
        model="gpt-4-vision-preview",  # Use the Vision-enabled model
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{base64_image}"
                        },
                    },
                ],
            }
        ],
        max_tokens=500,  # Adjust based on the expected output size
    )

    # Extract the response content
    details = response.choices[0].message.content
    return details

def save_to_csv(data, output_file):
    """Save extracted data to a CSV file."""
    # Convert JSON string to a dictionary
    import json
    data_dict = json.loads(data)

    # Convert dictionary to a DataFrame
    df = pd.DataFrame([data_dict])

    # Save DataFrame to CSV
    df.to_csv(output_file, index=False)
    print(f"Data saved to {output_file}")

# Example usage
if __name__ == "__main__":
    # Path to the passport image
    image_path = "passport_image.jpg"

    # Extract passport details
    passport_details = extract_passport_details(image_path)
    print("Extracted Details:", passport_details)

    # Save details to CSV
    save_to_csv(passport_details, "passport_details.csv")